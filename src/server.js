'use strict';

const express = require('express')
const bodyParser = require('body-parser');
const app = express()

var path = require("path");
app.use(function (req, res, next) {
  var filename = path.basename(req.url);
  var extension = path.extname(filename);
  console.log("The file " + filename + " was requested.");
  next();
});
app.use(bodyParser.json({limit: '50mb'}));
app.use(express.static('public'))

// Constants
const PORT = 8080;
const HOST = '0.0.0.0';

app.post('/get-pdf', async (req, res) => {
  const puppeteer = require('puppeteer');

  const browser = await puppeteer.launch({args: ['--no-sandbox', '--disable-setuid-sandbox']});
  const page = await browser.newPage();
  await page.setViewport({width: 1280, height: 1800})
  page.setJavaScriptEnabled(false)
  await page.setContent(req.body.htmlSource)

  // await page.screenshot({path: 'example.png'});
  const pdfFile = await page.pdf({
    format: 'A4',
    margin: {
      top: '3cm',
      left: '2cm',
      bottom: '3cm',
      right: '2cm'
    },
    headerTemplate: '<img style="width: 150px;margin-left:2cm;margin-top:0.5cm" src="data:image/png;base64,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">',
    footerTemplate: '<span style="font-size: 10px; width: 50px; height: 50px;margin-left: 2cm; font-family: ">Footer</span>',
    displayHeaderFooter: true
  });

  console.log('PDF generated')
  await browser.close();

  let base64data = pdfFile.toString('base64');
  res.send(base64data);
})

app.listen(PORT, HOST, () => {
  console.log(`App listening at http://localhost:${PORT}`)
})
